<div style="padding:12px;background:#fff3cd;border:1px solid #ffe58f;border-radius:8px;margin:12px 0;">
  Hello from index.html — if you can see this, the page is loading.
</div>

<script>
const form = document.getElementById("finderForm");
const resultsEl = document.getElementById("results");

/**
 * Create an element with optional class(es)
 */
function createEl(tag, cls) {
  const el = document.createElement(tag);
  if (cls) el.className = cls;
  return el;
}

/**
 * Create an anchor tag with safety attributes
 */
function createLink(href, text) {
  if (!href) return null;
  const a = document.createElement("a");
  a.href = href;
  a.target = "_blank";
  a.rel = "noopener noreferrer";
  a.textContent = text;
  return a;
}

/**
 * Render product search results
 */
function renderResults(results) {
  resultsEl.innerHTML = "";

  results.forEach(group => {
    // Category heading
    const h3 = createEl("h3", "category-header");
    h3.textContent = group.category || "Uncategorized";
    resultsEl.appendChild(h3);

    // Handle empty category
    if (!Array.isArray(group.items) || group.items.length === 0) {
      const p = createEl("p", "no-results");
      p.textContent = "No items passed ingredient screening.";
      resultsEl.appendChild(p);
      return;
    }

    // Product grid
    const grid = createEl("div", "product-grid");

    group.items.forEach(item => {
      const card = createEl("div", "product-card");

      // Title
      const title = createEl("h4", "product-title");
      title.textContent = item.name || "Unnamed Product";

      // Meta info
      const meta = createEl("div", "product-meta");
      const rating = item.rating ? `${item.rating.toFixed(1)}★` : "Unrated";
      const reviews = item.reviews ? ` • ${item.reviews} reviews` : "";
      const price = item.price ? ` • $${item.price}` : "";
      meta.textContent = `${rating}${reviews}${price}`;

      // Links
      const linksContainer = createEl("div", "product-links");
      const manufacturerLink = createLink(item.links?.manufacturer, "Manufacturer");
      const retailerLink = createLink(item.links?.primary, "Retailer");

      if (manufacturerLink) linksContainer.appendChild(manufacturerLink);
      if (manufacturerLink && retailerLink) {
        linksContainer.appendChild(document.createTextNode(" | "));
      }
      if (retailerLink) linksContainer.appendChild(retailerLink);

      // Assemble
      card.append(title, meta, linksContainer);
      grid.appendChild(card);
    });

    resultsEl.appendChild(grid);
  });
}

/**
 * Form submit handler
 */
form.addEventListener("submit", async e => {
  e.preventDefault();
  resultsEl.textContent = "Searching…";

  const allergens = (document.getElementById("allergens").value || "")
    .split(",").map(s => s.trim()).filter(Boolean);
  const categories = (document.getElementById("categories").value || "")
    .split(",").map(s => s.trim()).filter(Boolean);
  const notes = (document.getElementById("notes").value || "").trim();
  const rating_floor = Number(document.getElementById("rating_floor")?.value || 4.0);
  const purchase_sites = (document.getElementById("retailers")?.value || "")
    .split(",").map(s => s.trim()).filter(Boolean);

  try {
    const response = await fetch("/api/search", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        allergens,
        categories,
        notes,
        rating_floor,
        purchase_sites
      })
    });

    const data = await response.json();
    if (!data.ok) {
      resultsEl.textContent = data.error || "Search failed.";
      return;
    }

    renderResults(data.results || []);
  } catch (err) {
    console.error("Search request failed:", err);
    resultsEl.textContent = "An error occurred while searching.";
  }
});
</script>
