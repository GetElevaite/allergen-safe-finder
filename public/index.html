<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Allergen-Safe Product Finder</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="style.css" />

  <style>
    /* small, scoped additions */
    .label-required::after{ content:" *"; color:#dc3545; font-weight:700; }
    #geoStatus{ min-height:1.25rem; }
    .assurance{
      background:#e9f5ff; border:1px solid #cfe6ff; color:#0b4a7b;
      border-radius:10px; padding:12px 14px; margin:6px 0 18px;
    }
    .assurance strong{ font-weight:800; }
    .assurance .small-note{ display:block; color:#0b4a7b; opacity:.75; margin-top:4px; font-size:.9rem; }
  </style>
</head>
<body>
  <header>
    <h1>Allergen-Safe Product Finder</h1>
    <p class="mb-0">Find products safe for your specific allergies</p>
  </header>

  <main class="container my-4">
    <form id="finderForm" class="mb-4" novalidate>
      <div class="mb-3">
        <label for="allergens" class="form-label label-required">Allergens (comma-separated):</label>
        <input type="text" id="allergens" class="form-control" placeholder="e.g. Amidoamine, Propolis" required />
        <div class="invalid-feedback">Please enter at least one allergen.</div>
      </div>

      <div class="mb-3">
        <label for="categories" class="form-label label-required">Categories (comma-separated):</label>
        <input type="text" id="categories" class="form-control" placeholder="e.g. Shampoo, Sunscreen" required />
        <div class="invalid-feedback">Please enter at least one category.</div>
      </div>

      <div class="mb-3">
        <label for="notes" class="form-label">Notes or preferences:</label>
        <textarea id="notes" class="form-control" placeholder="Any extra preferences"></textarea>
      </div>

      <div class="row g-2">
        <div class="col-12 col-md-6">
          <label for="rating_floor" class="form-label">Minimum Rating (0–5):</label>
          <input type="number" id="rating_floor" class="form-control" value="4.0" step="0.1" min="0" max="5" />
        </div>

        <!-- Location -->
        <div class="col-12 col-md-6">
          <label class="form-label">Location:</label>
          <div class="inline-actions">
            <button type="button" id="useMyLocation" class="btn btn-outline-primary btn-inline">Use my location</button>
            <button type="button" id="enterManually" class="btn btn-outline-secondary btn-inline">Enter manually</button>
            <input type="text" id="geo" class="form-control d-none flex-grow-1" placeholder="ZIP or City, State" />
          </div>
          <div id="geoStatus" class="form-text"></div>
        </div>
      </div>

      <div class="row g-2 mb-3 mt-2">
        <div class="col-6">
          <label for="min_price" class="form-label">Min Price ($):</label>
          <input type="number" id="min_price" class="form-control" min="0" step="0.01" placeholder="0" />
        </div>
        <div class="col-6">
          <label for="max_price" class="form-label">Max Price ($):</label>
          <input type="number" id="max_price" class="form-control" min="0" step="0.01" placeholder="30" />
        </div>
      </div>

      <div class="mb-3">
        <label for="retailers" class="form-label label-required">Preferred Retailers (comma-separated):</label>
        <input type="text" id="retailers" class="form-control" placeholder="e.g. Target, Ulta, Walmart" required />
        <div class="invalid-feedback">Please enter at least one retailer.</div>
      </div>

      <button type="submit" class="btn btn-primary w-100 btn-submit">Search</button>
    </form>

    <!-- Assurance banner will be injected here before results -->
    <div id="assurance"></div>

    <div id="results"></div>
  </main>

  <footer class="site-footer">
    <div class="container footer-inner">
      <span class="footer-brand">ElevAIte</span>
      <span class="footer-tagline">AI solutions for consumers and small businesses</span>
    </div>
  </footer>

  <script>
    const form = document.getElementById("finderForm");
    const resultsEl = document.getElementById("results");
    const assuranceEl = document.getElementById("assurance");

    const geoBtn = document.getElementById("useMyLocation");
    const manualBtn = document.getElementById("enterManually");
    const geoInput = document.getElementById("geo");
    const geoStatus = document.getElementById("geoStatus");

    function createEl(tag, cls){ const el=document.createElement(tag); if(cls) el.className=cls; return el; }
    function createLink(href, text){ if(!href) return null; const a=document.createElement("a"); a.href=href; a.target="_blank"; a.rel="noopener noreferrer"; a.textContent=text; return a; }

    // Inline SVG placeholder
    const PLACEHOLDER='data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="176" height="176"><rect width="100%" height="100%" fill="#f1f3f5"/><rect x="20" y="20" width="136" height="96" rx="8" fill="#e6e8ec"/><circle cx="52" cy="52" r="20" fill="#d9dde2"/><rect x="20" y="130" width="120" height="16" rx="4" fill="#e0e3e8"/></svg>`);

    function buildProductCard(item){
      const card=createEl("div","product-card");
      const img=createEl("img","product-thumb");
      let candidate=(item.image&&String(item.image).trim())?String(item.image).trim():PLACEHOLDER;
      if(/^http:\/\//i.test(candidate)) candidate=candidate.replace(/^http:\/\//i,"https://");
      img.src=/^https?:\/\//i.test(candidate)?candidate:PLACEHOLDER;
      img.alt=item.name||"Product"; img.loading="lazy";
      img.onerror=()=>{ img.onerror=null; img.src=PLACEHOLDER; };

      const details=createEl("div");
      const title=createEl("h4","product-title"); title.textContent=item.name||"Unnamed Product";
      const meta=createEl("div","product-meta");
      const ratingText=(typeof item.rating==="number")?`⭐ ${item.rating.toFixed(1)}`:"Unrated";
      const reviewsText=item.reviews?` • ${item.reviews} reviews`:"";
      const priceText=item.price?` • ${String(item.price).startsWith("$")?item.price:`$${item.price}`}`:"";
      meta.textContent=`${ratingText}${reviewsText}${priceText}`;

      const links=createEl("div","product-links");
      const mfr=createLink(item.links?.manufacturer,"Manufacturer");
      const shop=createLink(item.links?.primary,"Retailer");
      if(mfr) links.appendChild(mfr);
      if(mfr && shop) links.appendChild(document.createTextNode(" | "));
      if(shop) links.appendChild(shop);

      details.append(title,meta,links);
      card.append(img,details);
      return card;
    }

    function renderResults(groups){
      resultsEl.innerHTML="";
      groups.forEach(group=>{
        const h3=createEl("h3","category-header");
        h3.textContent=group.category||"Uncategorized";
        resultsEl.appendChild(h3);

        const items=Array.isArray(group.items)?group.items:[];
        if(!items.length){
          const p=createEl("p","no-results");
          p.textContent="No items passed ingredient screening.";
          resultsEl.appendChild(p);
          return;
        }
        const grid=createEl("div","product-grid");
        items.forEach(item=>grid.appendChild(buildProductCard(item)));
        resultsEl.appendChild(grid);
      });
    }

    // --- Assurance banner ---
    function humanList(arr){
      if(arr.length <= 2) return arr.join(" and ");
      return arr.slice(0,-1).join(", ") + ", and " + arr[arr.length-1];
    }
    function renderAssurance(allergens){
      assuranceEl.innerHTML = "";
      const names = allergens.filter(Boolean);
      const label = names.length ? humanList(names) : "your selected allergens";
      const div = createEl("div","assurance");
      div.innerHTML = `
        <strong>Verified against your allergen list:</strong>
        These products contain no ${label} or known cross-reactors.
        <span class="small-note">We exclude any items with missing or ambiguous ingredient data.</span>
      `;
      assuranceEl.appendChild(div);
    }

    // --- Location helpers ---
    const reverseGeocode=async(lat,lon)=>{
      const url=`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`;
      const resp=await fetch(url); return resp.json();
    };

    geoBtn.addEventListener("click", async ()=>{
      if(!navigator.geolocation){ geoStatus.textContent="Geolocation not supported."; return; }
      geoStatus.textContent="Locating…"; geoBtn.disabled=true; manualBtn.disabled=true;

      navigator.geolocation.getCurrentPosition(async(pos)=>{
        try{
          const { latitude, longitude } = pos.coords;
          const data = await reverseGeocode(latitude, longitude);
          const city = data.city || data.locality || "";
          const state = data.principalSubdivision || data.region || "";
          const zip = data.postcode || "";
          let formatted = city && state ? `${city}, ${state}` : (zip || state || "");
          if(formatted){
            geoInput.classList.remove("d-none"); geoInput.readOnly=true; geoInput.value=formatted;
            geoStatus.textContent=`Location set to ${formatted}`;
          }else{
            geoStatus.textContent="Couldn't determine a nearby city/ZIP.";
            geoInput.classList.remove("d-none"); geoInput.readOnly=false; geoInput.focus();
          }
        }catch{
          geoStatus.textContent="Failed to look up your location.";
        }finally{
          geoBtn.disabled=false; manualBtn.disabled=false;
        }
      },(err)=>{
        geoStatus.textContent=(err.code===1)?"Permission denied — enter location manually.":"Unable to retrieve your location.";
        geoInput.classList.remove("d-none"); geoInput.readOnly=false; geoInput.focus();
        geoBtn.disabled=false; manualBtn.disabled=false;
      },{ enableHighAccuracy:false, timeout:8000, maximumAge:300000 });
    });

    manualBtn.addEventListener("click", ()=>{
      geoInput.classList.remove("d-none");
      geoInput.readOnly=false;
      geoInput.focus();
      geoStatus.textContent="Enter ZIP or City, State (optional).";
    });

    // --- Validation helpers ---
    function setInvalid(input,msg){ input.classList.add("is-invalid"); const fb=input.nextElementSibling; if(fb?.classList.contains("invalid-feedback")) fb.textContent=msg; }
    function clearInvalid(input){ input.classList.remove("is-invalid"); }

    // --- Submit ---
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();

      const allergensEl=document.getElementById("allergens");
      const categoriesEl=document.getElementById("categories");
      const retailersEl=document.getElementById("retailers");
      [allergensEl,categoriesEl,retailersEl].forEach(clearInvalid);

      let valid=true;
      if(!allergensEl.value.trim()){ setInvalid(allergensEl,"Please enter at least one allergen."); valid=false; }
      if(!categoriesEl.value.trim()){ setInvalid(categoriesEl,"Please enter at least one category."); valid=false; }
      if(!retailersEl.value.trim()){ setInvalid(retailersEl,"Please enter at least one retailer."); valid=false; }
      if(!valid){ resultsEl.textContent=""; (document.querySelector(".is-invalid")||allergensEl).focus(); return; }

      resultsEl.textContent="Searching…";

      const allergens = allergensEl.value.split(",").map(s=>s.trim()).filter(Boolean);
      const categories = categoriesEl.value.split(",").map(s=>s.trim()).filter(Boolean);
      const notes = (document.getElementById("notes").value||"").trim();
      const rating_floor = Number(document.getElementById("rating_floor")?.value || 4.0);
      const min_price = document.getElementById("min_price")?.value;
      const max_price = document.getElementById("max_price")?.value;
      const price_min = min_price===""?null:Number(min_price);
      const price_max = max_price===""?null:Number(max_price);
      const location = (geoInput.classList.contains("d-none") ? "" : (geoInput.value||"")).trim();
      const purchase_sites = retailersEl.value.split(",").map(s=>s.trim()).filter(Boolean);

      try{
        const res = await fetch("/api/search", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ allergens,categories,notes,rating_floor,purchase_sites,price_min,price_max,location })
        });
        const data = await res.json();
        if(!data.ok){ resultsEl.textContent = data.error || "Search failed."; return; }

        // inject assurance banner before rendering results
        renderAssurance(allergens);

        renderResults(data.results || []);
      }catch(err){
        console.error("Search request failed:", err);
        resultsEl.textContent="An error occurred while searching.";
        assuranceEl.innerHTML = "";
      }
    });
  </script>
</body>
</html>
